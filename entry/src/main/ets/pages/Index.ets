import { promptAction } from '@kit.ArkUI' // å¯¼å…¥ArkUIå·¥å…·åŒ…ä¸­çš„æç¤ºæ“ä½œæ¨¡å—
// åœ¨ Index.ets æˆ–å…¶ä»–é¡µé¢æ–‡ä»¶ä¸­å¯¼å…¥ AVPlayerManager
import { AVPlayerManager } from '../manager/AVPlayerManager';
// åœ¨ Index.ets æˆ–å…¶ä»–é¡µé¢æ–‡ä»¶ä¸­å¯¼å…¥ AVPlayerManager
import router from '@system.router';

@ObservedV2 // è§‚å¯Ÿè€…æ¨¡å¼è£…é¥°å™¨
class Cell { // å®šä¹‰æ¸¸æˆä¸­çš„å•å…ƒæ ¼ç±»
  @Trace // è·Ÿè¸ªè£…é¥°å™¨ï¼Œæ ‡è®°å±æ€§ä»¥è¢«è·Ÿè¸ª
  type: number = 0; // å•å…ƒæ ¼ç±»å‹ï¼Œ0ï¼šé€æ˜ï¼Œ1ï¼šå¢™ï¼Œ2ï¼šå¯ç§»åŠ¨åŒºåŸŸ
  @Trace topLeft: number = 0; // å·¦ä¸Šè§’åœ†è§’å¤§å°
  @Trace topRight: number = 0; // å³ä¸Šè§’åœ†è§’å¤§å°
  @Trace bottomLeft: number = 0; // å·¦ä¸‹è§’åœ†è§’å¤§å°
  @Trace bottomRight: number = 0; // å³ä¸‹è§’åœ†è§’å¤§å°
  @Trace x: number = 0; // å•å…ƒæ ¼çš„Xåæ ‡åç§»é‡
  @Trace y: number = 0; // å•å…ƒæ ¼çš„Yåæ ‡åç§»é‡
  constructor(cellType: number) { // æ„é€ å‡½æ•°
    this.type = cellType; // åˆå§‹åŒ–å•å…ƒæ ¼ç±»å‹
  }
}
@ObservedV2 // è§‚å¯Ÿè€…æ¨¡å¼è£…é¥°å™¨
class MyPosition { // å®šä¹‰ä½ç½®ç±»
  @Trace // è·Ÿè¸ªè£…é¥°å™¨ï¼Œæ ‡è®°å±æ€§ä»¥è¢«è·Ÿè¸ª
  x: number = 0; // Xåæ ‡
  @Trace y: number = 0; // Yåæ ‡

  constructor(x: number = 0, y: number = 0) { // æ„é€ å‡½æ•°ï¼Œæ¥å—xå’Œyä¸¤ä¸ªå‚æ•°
    this.x = x;
    this.y = y;
  }
  setPosition(x: number, y: number) { // è®¾ç½®ä½ç½®çš„æ–¹æ³•
    this.x = x; // æ›´æ–°Xåæ ‡
    this.y = y; // æ›´æ–°Yåæ ‡
  }
}

interface DirectionFrames {
  up: Resource[];
  down: Resource[];
  left:Resource[];
  right: Resource[];
}

interface IdleImages {
  up: Resource;
  down:Resource;
  left:Resource;
  right: Resource;
}


@Entry // å…¥å£è£…é¥°å™¨
@Component // ç»„ä»¶è£…é¥°å™¨
struct Sokoban  { // å®šä¹‰æ¸¸æˆä¸»ç»“æ„
  cellWidth: number = 80; // å•å…ƒæ ¼å®½åº¦
  @State grid: Cell[][] = [];// æ¸¸æˆç½‘æ ¼çŠ¶æ€
  @State victoryPositions: MyPosition[] = [];// èƒœåˆ©ä½ç½®æ•°ç»„
  @State cratePositions: MyPosition[] = [];// ç®±å­ä½ç½®æ•°ç»„
  @State playerImage: Resource = $r('app.media.Character4'); // åˆå§‹è§’è‰²å›¾ç‰‡
playerPosition: MyPosition = new MyPosition(); // ç©å®¶ä½ç½®
  @State screenStartX: number = 0; // è§¦æ‘¸å¼€å§‹æ—¶çš„å±å¹•Xåæ ‡
  @State screenStartY: number = 0; // è§¦æ‘¸å¼€å§‹æ—¶çš„å±å¹•Yåæ ‡
  @State lastScreenX: number = 0; // è§¦æ‘¸ç»“æŸæ—¶çš„å±å¹•Xåæ ‡
  @State lastScreenY: number = 0; // è§¦æ‘¸ç»“æŸæ—¶çš„å±å¹•Yåæ ‡
  @State startTime: number = 0; // æ¸¸æˆå¼€å§‹æ—¶é—´
  @State isAnimationRunning: boolean = false; // åŠ¨ç”»æ˜¯å¦æ­£åœ¨è¿è¡Œ
  @State moveDirection: string = ""; // å½“å‰ç§»åŠ¨æ–¹å‘ï¼Œç”¨äºåˆ‡æ¢å›¾ç‰‡
  @State historyPlayerPositions: MyPosition[] = []; // ç©å®¶ä½ç½®å†å²
  @State historyCratePositions: MyPosition[][] = []; // å­˜å‚¨ç®±å­ä½ç½®çš„æ•°ç»„çš„æ•°ç»„
  private avPlayerManager: AVPlayerManager = new AVPlayerManager();
  @State isMusicPlaying: boolean = false;
  @State level: number = 1; // é»˜è®¤å¯åŠ¨å…³å¡1

  @State timeout: number = 30000; // é»˜è®¤30ç§’
  @State timer: number | null = null; // å®šæ—¶å™¨å¼•ç”¨
  @State countdown: number = 30; // å€’è®¡æ—¶åˆå§‹å€¼ï¼Œå•ä½ä¸ºç§’
  @State countdownInterval: number | null = null; // å€’è®¡æ—¶å®šæ—¶å™¨å¼•ç”¨
  aboutToAppear(): void {
    // è·å–ä¼ é€’çš„å…³å¡å·
    let params = router.getParams();
    if (params && params.level) {
      this.level = Number(params.level); // è®¾ç½®å…³å¡å·
    }
    this.initializeGame(this.level); // åˆå§‹åŒ–æ¸¸æˆå¹¶åŠ è½½å¯¹åº”å…³å¡åœ°å›¾
    this.avPlayerManager.playMusicByRawSrc('rawfile/bg.mp3');// ç¡®ä¿è·¯å¾„æ­£ç¡®
  }

  playMusic(): void {
    this.avPlayerManager.continueMusic(); // ç»§ç»­éŸ³ä¹æ’­æ”¾
    this.isMusicPlaying = true;
  }

  pauseMusic(): void {
    this.avPlayerManager.stopMusic(); // æš‚åœéŸ³ä¹æ’­æ”¾
    this.isMusicPlaying = false;
  }

  toggleMusic(): void {
    if (this.isMusicPlaying) {
      this.pauseMusic();
    } else {
      this.playMusic();
    }
  }

  gameOver(): void {
    clearInterval(this.countdownInterval); // æ¸…é™¤å®šæ—¶å™¨
    clearTimeout(this.timer); // æ¸…é™¤å®šæ—¶å™¨
    promptAction.showDialog({
      title: 'æ¸¸æˆå¤±è´¥',
      message: 'æ—¶é—´å·²åˆ°ï¼Œæœªèƒ½å®Œæˆæ¸¸æˆã€‚',
      buttons: [{ text: 'é‡æ–°å¼€å§‹', color: '#ffa500' }]
    }).then(() => {
      this.initializeGame(this.level); // é‡æ–°å¼€å§‹å½“å‰å…³å¡
    });
  }

  initializeGame(level: number): void {
    // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨å’Œå€’è®¡æ—¶çŠ¶æ€
    if (this.timer) {
      clearTimeout(this.timer);
    }
    if (this.countdownInterval) {
      clearInterval(this.countdownInterval);
    }
    this.startTime = Date.now();
    this.timeout = level <= 2 ? 30000 : 60000; // ç¬¬1,2å…³30ç§’ï¼Œç¬¬3,4,5å…³60ç§’
    this.timer = setTimeout(() => this.gameOver(), this.timeout); // è®¾ç½®å®šæ—¶å™¨
    this.countdown = this.timeout / 1000; // å°†æ¯«ç§’è½¬æ¢ä¸ºç§’
    this.countdownInterval = setInterval(() => {
      if (this.countdown > 0) {
        this.countdown--; // æ¯ç§’å‡å°‘1
      } else {
        clearInterval(this.countdownInterval); // æ¸…é™¤å®šæ—¶å™¨
        this.gameOver(); // æ¸¸æˆå¤±è´¥
      }
    }, 1000);
    if (level === 4) {
      this.grid = [
        [new Cell(0), new Cell(1), new Cell(1), new Cell(1), new Cell(1), new Cell(1)],
        [new Cell(1), new Cell(1), new Cell(2), new Cell(2), new Cell(2), new Cell(1)],
        [new Cell(1), new Cell(2), new Cell(2), new Cell(2), new Cell(1), new Cell(1)],
        [new Cell(1), new Cell(2), new Cell(2), new Cell(2), new Cell(2), new Cell(1)],
        [new Cell(1), new Cell(1), new Cell(2), new Cell(2), new Cell(2), new Cell(1)],
        [new Cell(0), new Cell(1), new Cell(1), new Cell(1), new Cell(1), new Cell(1)],
      ];
      this.victoryPositions = [new MyPosition(), new MyPosition()];
      this.cratePositions = [new MyPosition(), new MyPosition()];
      this.victoryPositions[0].setPosition(1, 3);
      this.victoryPositions[1].setPosition(1, 4);
      this.cratePositions[0].setPosition(2, 2);
      this.cratePositions[1].setPosition(2, 3);
      this.playerPosition.setPosition(1, 2);
      this.playerImage = $r('app.media.Character4'); // åˆå§‹å›¾ç‰‡
    } else if (level === 5) {
      this.grid = [
        [new Cell(0), new Cell(0), new Cell(0), new Cell(1), new Cell(1), new Cell(1), new Cell(1), new Cell(1)],
        [new Cell(1), new Cell(1), new Cell(1), new Cell(1), new Cell(2), new Cell(2), new Cell(2), new Cell(1)],
        [new Cell(1), new Cell(2), new Cell(2), new Cell(1), new Cell(1), new Cell(2), new Cell(2), new Cell(1)],
        [new Cell(1), new Cell(2), new Cell(2), new Cell(2), new Cell(2), new Cell(2), new Cell(2), new Cell(1)],
        [new Cell(1), new Cell(1), new Cell(2), new Cell(1), new Cell(1), new Cell(2), new Cell(2), new Cell(1)],
        [new Cell(1), new Cell(1), new Cell(2), new Cell(2), new Cell(2), new Cell(1), new Cell(2), new Cell(1)],
        [new Cell(0), new Cell(1), new Cell(1), new Cell(1), new Cell(2), new Cell(2), new Cell(2), new Cell(1)],
        [new Cell(0), new Cell(0), new Cell(0), new Cell(1), new Cell(1), new Cell(1), new Cell(1), new Cell(1)],
      ];
      this.victoryPositions = [new MyPosition(), new MyPosition(), new MyPosition()];
      this.cratePositions = [new MyPosition(), new MyPosition(), new MyPosition()];
      // èƒœåˆ©ä½ç½®
      this.victoryPositions[0].setPosition(1, 4); // å·¦ä¸Š
      this.victoryPositions[1].setPosition(1, 5); // å³ä¸Š
      this.victoryPositions[2].setPosition(4, 6); // ä¸­é—´é ä¸‹
      // ç®±å­ä½ç½®
      this.cratePositions[0].setPosition(2, 5); // å¯æ¨å‘èƒœåˆ©ä½ç½® (1, 1)
      this.cratePositions[1].setPosition(3, 2); // å¯æ¨å‘èƒœåˆ©ä½ç½® (1, 5)
      this.cratePositions[2].setPosition(5, 6); // å¯æ¨å‘èƒœåˆ©ä½ç½® (4, 3)
      // ç©å®¶åˆå§‹ä½ç½®
      this.playerPosition.setPosition(2, 2);
      this.playerImage = $r('app.media.Character4'); // åˆå§‹å›¾ç‰‡
    }
    else if (level ===1 ) {
      this.grid = [
        [new Cell(1), new Cell(1), new Cell(1), new Cell(1), new Cell(1),  new Cell(1)],
        [new Cell(1), new Cell(2), new Cell(2), new Cell(2), new Cell(2),  new Cell(1)],
        [new Cell(1), new Cell(2), new Cell(2), new Cell(2), new Cell(2),  new Cell(1)],
        [new Cell(1), new Cell(2), new Cell(2), new Cell(2), new Cell(2),  new Cell(1)],
        [new Cell(1), new Cell(2), new Cell(2), new Cell(2), new Cell(2),  new Cell(1)],
        [new Cell(1), new Cell(2), new Cell(2), new Cell(2), new Cell(2),  new Cell(1)],
        [new Cell(1), new Cell(2), new Cell(2), new Cell(2), new Cell(2),  new Cell(1)],
        [new Cell(1), new Cell(2), new Cell(2), new Cell(2), new Cell(2),  new Cell(1)],
        [new Cell(1), new Cell(1), new Cell(1), new Cell(1), new Cell(1),  new Cell(1)],
      ];
      this.victoryPositions = [new MyPosition(), new MyPosition(), new MyPosition(),new MyPosition(),new MyPosition()];
      this.cratePositions = [new MyPosition(), new MyPosition(), new MyPosition(),new MyPosition(),new MyPosition()];
      // èƒœåˆ©ä½ç½®
      this.victoryPositions[0].setPosition(2, 3); // å·¦ä¸Š
      this.victoryPositions[1].setPosition(3, 3); // å³ä¸Š
      this.victoryPositions[2].setPosition(4, 3); // ä¸­é—´é ä¸‹
      this.victoryPositions[3].setPosition(5, 3); // ä¸­é—´é ä¸‹
      this.victoryPositions[4].setPosition(5, 2); // ä¸­é—´é ä¸‹
      // ç®±å­ä½ç½®
      this.cratePositions[0].setPosition(2, 2); // å¯æ¨å‘èƒœåˆ©ä½ç½® (1, 1)
      this.cratePositions[1].setPosition(3, 2); // å¯æ¨å‘èƒœåˆ©ä½ç½® (1, 5)
      this.cratePositions[2].setPosition(4, 2); // å¯æ¨å‘èƒœåˆ©ä½ç½® (4, 3)
      this.cratePositions[3].setPosition(5, 2); // å¯æ¨å‘èƒœåˆ©ä½ç½® (4, 3)
      this.cratePositions[4].setPosition(2, 3); // å¯æ¨å‘èƒœåˆ©ä½ç½® (4, 3)
      // ç©å®¶åˆå§‹ä½ç½®
      this.playerPosition.setPosition(1, 1);
      this.playerImage = $r('app.media.Character4'); // åˆå§‹å›¾ç‰‡
    }
    else if (level ===2 ) {
      this.grid = [
        [new Cell(0), new Cell(0), new Cell(0), new Cell(1), new Cell(1),  new Cell(1),  new Cell(0)],
        [new Cell(0), new Cell(1), new Cell(1), new Cell(1), new Cell(2),  new Cell(1),  new Cell(0)],
        [new Cell(0), new Cell(1), new Cell(2), new Cell(2), new Cell(2),  new Cell(1),  new Cell(1)],
        [new Cell(1), new Cell(1), new Cell(1), new Cell(2), new Cell(2),  new Cell(2),  new Cell(1)],
        [new Cell(1), new Cell(2), new Cell(2), new Cell(2), new Cell(1),  new Cell(1),  new Cell(1)],
        [new Cell(1), new Cell(1), new Cell(2), new Cell(2), new Cell(1),  new Cell(0),  new Cell(0)],
        [new Cell(0), new Cell(1), new Cell(2), new Cell(1), new Cell(1),  new Cell(0),  new Cell(0)],
        [new Cell(0), new Cell(1), new Cell(1), new Cell(1), new Cell(0),  new Cell(0),  new Cell(0)],
      ];
      this.victoryPositions = [new MyPosition(), new MyPosition(), new MyPosition(),new MyPosition(),new MyPosition(),new MyPosition()];
      this.cratePositions = [new MyPosition(), new MyPosition(), new MyPosition(),new MyPosition(),new MyPosition(),new MyPosition()];
      // èƒœåˆ©ä½ç½®
      this.victoryPositions[0].setPosition(1, 4); // å·¦ä¸Š
      this.victoryPositions[1].setPosition(2, 2); // å³ä¸Š
      this.victoryPositions[2].setPosition(3, 5); // ä¸­é—´é ä¸‹
      this.victoryPositions[3].setPosition(4, 1); // ä¸­é—´é ä¸‹
      this.victoryPositions[4].setPosition(6, 2); // ä¸­é—´é ä¸‹
      this.victoryPositions[5].setPosition(5, 3); // ä¸­é—´é ä¸‹
      // ç®±å­ä½ç½®
      this.cratePositions[0].setPosition(2, 3); // å¯æ¨å‘èƒœåˆ©ä½ç½® (1, 1)
      this.cratePositions[1].setPosition(2, 4); // å¯æ¨å‘èƒœåˆ©ä½ç½® (1, 5)
      this.cratePositions[2].setPosition(3, 4); // å¯æ¨å‘èƒœåˆ©ä½ç½® (4, 3)
      this.cratePositions[3].setPosition(4, 2); // å¯æ¨å‘èƒœåˆ©ä½ç½® (4, 3)
      this.cratePositions[4].setPosition(5, 2); // å¯æ¨å‘èƒœåˆ©ä½ç½® (4, 3)
      this.cratePositions[5].setPosition(5, 3); // å¯æ¨å‘èƒœåˆ©ä½ç½® (4, 3)
      // ç©å®¶åˆå§‹ä½ç½®
      this.playerPosition.setPosition(3, 3);
      this.playerImage = $r('app.media.Character4'); // åˆå§‹å›¾ç‰‡
    }
    else if (level === 3) {
      this.grid = [
        [new Cell(1), new Cell(1), new Cell(1), new Cell(1),  new Cell(1)],
        [new Cell(1), new Cell(2), new Cell(2), new Cell(2),  new Cell(1)],
        [new Cell(1), new Cell(2), new Cell(2), new Cell(2),  new Cell(1)],
        [new Cell(1), new Cell(2), new Cell(2), new Cell(2),  new Cell(1)],
        [new Cell(1), new Cell(2), new Cell(2), new Cell(2),  new Cell(1)],
        [new Cell(1), new Cell(1), new Cell(1), new Cell(1),  new Cell(1)],
      ];
      this.victoryPositions = [new MyPosition(), new MyPosition(), new MyPosition()];
      this.cratePositions = [new MyPosition(), new MyPosition(), new MyPosition()];
      // èƒœåˆ©ä½ç½®
      this.victoryPositions[0].setPosition(1, 1); // å·¦ä¸Š
      this.victoryPositions[1].setPosition(2, 1); // å³ä¸Š
      this.victoryPositions[2].setPosition(4, 3); // ä¸­é—´é ä¸‹
      // ç®±å­ä½ç½®
      this.cratePositions[0].setPosition(2, 2); // å¯æ¨å‘èƒœåˆ©ä½ç½® (1, 1)
      this.cratePositions[1].setPosition(3, 2); // å¯æ¨å‘èƒœåˆ©ä½ç½® (1, 5)
      this.cratePositions[2].setPosition(4, 2); // å¯æ¨å‘èƒœåˆ©ä½ç½® (4, 3)
      // ç©å®¶åˆå§‹ä½ç½®
      this.playerPosition.setPosition(1, 3);
      this.playerImage = $r('app.media.Character4'); // åˆå§‹å›¾ç‰‡
    }
  }
  updatePlayerImage(): void {
    const directionFrames: DirectionFrames = {
      up: [$r('app.media.Character8'), $r('app.media.Character9')],
      down: [$r('app.media.Character5'), $r('app.media.Character6')],
      left: [$r('app.media.Character10')],
      right: [$r('app.media.Character3')],
    };

    // åŠ¨æ€åˆ‡æ¢è¡Œèµ°å›¾ç‰‡
    if (this.moveDirection === "up") {
      this.playerImage = this.playerImage === directionFrames.up[0] ? directionFrames.up[1] : directionFrames.up[0];
    } else if (this.moveDirection === "down") {
      this.playerImage = this.playerImage === directionFrames.down[0] ? directionFrames.down[1] : directionFrames.down[0];
    } else if (this.moveDirection === "left") {
      this.playerImage = directionFrames.left[0];
    } else if (this.moveDirection === "right") {
      this.playerImage = directionFrames.right[0];
    }
  }


  stopPlayerAnimation(): void {
    // é™æ­¢æ—¶åˆ‡æ¢ä¸ºé™æ­¢å›¾ç‰‡
    const idleImages: IdleImages ={
      up: $r('app.media.Character7'),
      down: $r('app.media.Character4'),
      left: $r('app.media.Character1'),
      right: $r('app.media.Character2'),
    };
    // æ£€æŸ¥ moveDirection æ˜¯å¦æ˜¯é¢„å®šä¹‰çš„æ–¹å‘ä¹‹ä¸€
    if (this.moveDirection === "up") {
      this.playerImage = idleImages.up;
    } else if (this.moveDirection === "down") {
      this.playerImage = idleImages.down;
    } else if (this.moveDirection === "left") {
      this.playerImage = idleImages.left;
    } else if (this.moveDirection === "right") {
      this.playerImage = idleImages.right;
    }

    this.moveDirection = ""; // åœæ­¢ç§»åŠ¨æ–¹å‘
  }


  isVictoryPositionVisible(x: number, y: number): boolean { // åˆ¤æ–­ä½ç½®æ˜¯å¦ä¸ºèƒœåˆ©ä½ç½®
    return this.victoryPositions.some(position => position.x === x && position.y === y); // è¿”å›æ˜¯å¦æœ‰èƒœåˆ©ä½ç½®ä¸ç»™å®šä½ç½®åŒ¹é…
  }
  isCratePositionVisible(x: number, y: number): boolean { // åˆ¤æ–­ä½ç½®æ˜¯å¦ä¸ºç®±å­ä½ç½®
    return this.cratePositions.some(position => position.x === x && position.y === y); // è¿”å›æ˜¯å¦æœ‰ç®±å­ä½ç½®ä¸ç»™å®šä½ç½®åŒ¹é…
  }
  isPlayerPositionVisible(x: number, y: number): boolean { // åˆ¤æ–­ä½ç½®æ˜¯å¦ä¸ºç©å®¶ä½ç½®
    return this.playerPosition.x === x && this.playerPosition.y === y; // è¿”å›ç©å®¶ä½ç½®æ˜¯å¦ä¸ç»™å®šä½ç½®ç›¸åŒ
  }

  movePlayer(direction: string) {
    // åœ¨ç§»åŠ¨å‰ï¼Œä¿å­˜å½“å‰ä½ç½®åˆ°å†å²ä½ç½®æ•°ç»„
    this.historyPlayerPositions.push(new MyPosition(this.playerPosition.x,this.playerPosition.y));
    this.historyCratePositions.push(this.cratePositions.map(crate => new MyPosition(crate.x, crate.y)));

    if (this.isAnimationRunning) {
      return;
    }

    this.moveDirection = direction; // è®¾ç½®å½“å‰æ–¹å‘
    const directions: object = Object({
      'right': Object({ dx: 0, dy:  1}),
      'left': Object({ dx:0 , dy:-1 }),
      'down': Object({ dx: 1, dy: 0 }),
      'up': Object({ dx: -1, dy: 0 })
    });
    const dx: number = directions[direction]['dx']; //{ dx, dy }
    const dy: number = directions[direction]['dy']; //{ dx, dy }
    const newX: number = this.playerPosition.x + dx;
    const newY: number = this.playerPosition.y + dy;

    // åˆ¤æ–­ç›®æ ‡å•å…ƒæ ¼æ˜¯å¦æœ‰æ•ˆï¼ˆæ˜¯å¦è¶Šç•Œæˆ–ä¸ºå¢™ï¼‰
    if (!this.grid[newX] || !this.grid[newX][newY] || this.grid[newX][newY].type === 1) {
      return; // å¦‚æœç›®æ ‡ä½ç½®æ— æ•ˆæˆ–æ˜¯å¢™ï¼Œé˜»æ­¢ç©å®¶ç§»åŠ¨
    }
    // æ£€æŸ¥ç›®æ ‡ä½ç½®æ˜¯å¦æœ‰ç®±å­
    if (this.isCratePositionVisible(newX, newY)) {
      const crateIndex = this.cratePositions.findIndex(crate => crate.x === newX && crate.y === newY);
      const crateNewX = newX + dx;

      const crateNewY = newY + dy;

      // å¦‚æœç®±å­åæ–¹æ²¡æœ‰ç©ºé—´ï¼Œé˜»æ­¢ç©å®¶å’Œç®±å­ç§»åŠ¨
      if (!this.grid[crateNewX] || !this.grid[crateNewX][crateNewY] || this.grid[crateNewX][crateNewY].type !== 2 || this.isCratePositionVisible(crateNewX, crateNewY)) {
        return; // é˜»æ­¢ç©å®¶å’Œç®±å­ç§»åŠ¨
      }

      // å¦‚æœç®±å­å¯ä»¥ç§»åŠ¨ï¼Œæ›´æ–°ç®±å­ä½ç½®
      this.cratePositions[crateIndex].setPosition(crateNewX, crateNewY);
      // æ’­æ”¾éŸ³æ•ˆ
      this.avPlayerManager.playSoundEffectByRawSrc('rawfile/p.mp3');// ç¡®ä¿è·¯å¾„æ­£ç¡®
    }

    // å¦‚æœç›®æ ‡ä½ç½®æ²¡æœ‰ç®±å­æˆ–ç®±å­è¢«æˆåŠŸæ¨åŠ¨ï¼Œåˆ™æ›´æ–°ç©å®¶ä½ç½®
    this.playerPosition.setPosition(newX, newY);

    // æ›´æ–°è¡Œèµ°å›¾ç‰‡
    this.isAnimationRunning = true;
    this.updatePlayerImage();

      setTimeout(() => {
        this.stopPlayerAnimation(); // åœæ­¢åŠ¨ç”»å¹¶è®¾ç½®é™æ­¢å›¾ç‰‡
        this.isAnimationRunning = false;
      }, 150); // åŠ¨ç”»åˆ‡æ¢æ—¶é—´

    // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰ç®±å­éƒ½åœ¨èƒœåˆ©ä½ç½®
    const allCratesOnVictory = this.cratePositions.every(crate =>
    this.victoryPositions.some(victory => crate.x === victory.x && crate.y === victory.y)
    );

    if (allCratesOnVictory) {
        const elapsed = Date.now() - this.startTime;
        if (elapsed < this.timeout) {
          console.log("æ­å–œä½ ï¼Œä½ èµ¢äº†ï¼");
          let nextButtonText = 'ä¸‹ä¸€å…³';
          if (this.level === 5) {
            nextButtonText = 'è¿”å›ä¸»é¡µ';
          }
          promptAction.showDialog({
            title: 'æ¸¸æˆæˆåŠŸï¼',
            message: 'æ­å–œä½ ï¼Œç”¨æ—¶ï¼š' + (elapsed / 1000).toFixed(3) + 'ç§’',
            buttons: [{ text: nextButtonText, color: '#ffa500' }]
          }).then(() => {
            if (this.level !== 5) {
              this.initializeGame(this.level+1);
              this.level = this.level+1;
            }else{
              router.push({
                uri: 'pages/MenuPage', // è¯·æ ¹æ®æ‚¨çš„å®é™…è·¯å¾„è°ƒæ•´
              });
            }


          });
        } else {
          this.gameOver(); // æ—¶é—´å·²åˆ°ï¼Œæ¸¸æˆå¤±è´¥
        }

    } else {
      // å¦‚æœæ²¡æœ‰èƒœåˆ©ï¼Œç»§ç»­æ¸¸æˆ
      setTimeout(() => {
        this.stopPlayerAnimation(); // åœæ­¢åŠ¨ç”»å¹¶è®¾ç½®é™æ­¢å›¾ç‰‡
        this.isAnimationRunning = false;
      }, 150);
    }
  }

  undoMove() {
    if (this.historyPlayerPositions.length > 0 && this.historyCratePositions.length > 0) {
      // å–å‡ºæœ€åçš„ä½ç½®
      const lastPlayerPosition = this.historyPlayerPositions.pop();
      const lastCratePositions = this.historyCratePositions.pop();

      if (lastPlayerPosition && lastCratePositions) {
        // æ¢å¤ç©å®¶å’Œç®±å­çš„ä½ç½®
        this.playerPosition.setPosition(lastPlayerPosition.x, lastPlayerPosition.y);
        this.cratePositions = lastCratePositions.map(crate => new MyPosition(crate.x, crate.y));
      }
    }
  }

  build() {
    Column({ space: 20 }) {
      // æ¸¸æˆåŒº
      Text(`å‰©ä½™æ—¶é—´: ${this.countdown}ç§’`)
        .fontSize(20)
        .fontColor("#ffffffff")
        .alignSelf(ItemAlign.End)
        .fontWeight(800)
        .margin({ top: 10, right: 20 })

      Stack() {
        // éé›¶åŒºåŠ ç“·ç –
        Column() {
          ForEach(this.grid, (row: [], rowIndex: number) => {
            Row() {
              ForEach(row, (item: Cell, colIndex: number) => {
                Stack() {
                  Text()
                    .width(`${this.cellWidth}lpx`)
                    .height(`${this.cellWidth}lpx`)
                    .backgroundColor(
                      item.type == 0
                        ? Color.Transparent
                        : (rowIndex + colIndex) % 2 == 0
                        ? "#cfb381"
                        : "#e1ca9f"
                    )
                    .borderRadius({
                      topLeft: item.topLeft > 10 ? item.topLeft : 0,
                      topRight: item.topRight > 10 ? item.topRight : 0,
                      bottomLeft: item.bottomLeft > 10 ? item.bottomLeft : 0,
                      bottomRight: item.bottomRight > 10 ? item.bottomRight : 0,
                    });
                  // å¦‚æœæ˜¯èƒœåˆ©åæ ‡ï¼Œæ˜¾ç¤ºå‰å·
                  Stack() {
                    Text()
                    // èƒœåˆ©åæ ‡å›¾ç‰‡
                    Image($r('app.media.vegtor'))// ä½¿ç”¨èµ„æºæ ‡è¯†ç¬¦åŠ è½½å›¾ç‰‡
                      .width(`${this.cellWidth}lpx`)
                      .height(`${this.cellWidth}lpx`)
                      .visibility(
                        this.isVictoryPositionVisible(rowIndex, colIndex)
                          ? Visibility.Visible
                          : Visibility.None
                      );
                  }
                }
              });
            };
          });
        }

          Column() {
            ForEach(this.grid, (row: [], rowIndex: number) => {
              Row() {
                ForEach(row, (item: Cell, colIndex: number) => {
                  Stack() {
                    // æ˜¯å¦æ˜¾ç¤ºç®±å­
                    Stack() {
                      if (item.type === 1) {
                        // å¦‚æœç±»å‹ä¸º 1ï¼Œæ˜¾ç¤º block.png
                        Image($r('app.media.block'))
                          .width(`${this.cellWidth}lpx`)
                          .height(`${this.cellWidth}lpx`)
                          .borderRadius({
                            topLeft: item.topLeft,
                            topRight: item.topRight,
                            bottomLeft: item.bottomLeft,
                            bottomRight: item.bottomRight,
                          });
                      }
                      // ç®±å­å›¾ç‰‡
                      Image($r('app.media.fu')) // ä½¿ç”¨èµ„æºæ ‡è¯†ç¬¦åŠ è½½å›¾ç‰‡
                        .width(`${this.cellWidth-30}lpx`)
                        .height(`${this.cellWidth-30}lpx`)
                        .backgroundColor(Color.Transparent) // è®¾ç½®èƒŒæ™¯ä¸ºé€æ˜
                        .visibility(
                          this.isCratePositionVisible(rowIndex, colIndex)
                            ? Visibility.Visible
                            : Visibility.None
                        );
                    }
                    .width(`${this.cellWidth}lpx`)
                    .height(`${this.cellWidth}lpx`)
                    .backgroundColor(Color.Transparent) // è®¾ç½®èƒŒæ™¯ä¸ºé€æ˜
                    .translate({
                      x: `${item.x}lpx`,
                      y: `${item.y}lpx`,
                    });

                  // æ¸²æŸ“ç©å®¶è§’è‰²
                  if (this.playerPosition.x === rowIndex && this.playerPosition.y === colIndex) {
                    Image(this.playerImage)// ä½¿ç”¨èµ„æºæ ‡è¯†ç¬¦åŠ è½½å›¾ç‰‡
                      .width(`${this.cellWidth - 10}lpx`)
                      .height(`${this.cellWidth - 10}lpx`)
                      .margin({ top: 5, bottom: 5, left: 5, right: 5 }); // æ·»åŠ å†…è¾¹è·
                  }
                }
                .width(`${this.cellWidth}lpx`)
                .height(`${this.cellWidth}lpx`);

              });
            };
          });
        }
      }.margin({ top: 140})
      Stack() {
        Button("ğŸµ")
          .onClick(() => {
            this.toggleMusic();
          }).fontSize("40px")
          .width("150px")
          .height("90px")
          .backgroundColor("#ffffffff")
          .fontColor("black")
      }.width("100px")
      .height("100px")
      .position({ top: 10, left: 10 })// å·¦ä¸Šè§’


      // å…¶ä»–æŒ‰é’®ï¼ˆåº•éƒ¨æ¨ªå‘æ’åˆ—ï¼‰
      Row({ space: 20 }) {
        Button("é‡æ–°å¼€å§‹")
          .backgroundColor("#ffffffff")
          .fontColor("black")
          .clickEffect({ level: ClickEffectLevel.MIDDLE })
          .onClick(() => {
            this.initializeGame(this.level);
          });
        Button("å…³å¡é€‰æ‹©")
          .backgroundColor("#ffffffff")
          .fontColor("black")
          .clickEffect({ level: ClickEffectLevel.MIDDLE })
          .onClick(() => {
            router.push({
              uri: 'pages/LevelPage', // è¯·æ ¹æ®æ‚¨çš„å®é™…è·¯å¾„è°ƒæ•´
            });
          });
        Button("å›é€€")
          .backgroundColor("#ffffffff")
          .fontColor("black")
          .clickEffect({ level: ClickEffectLevel.MIDDLE })
          .onClick(() => {
            this.undoMove();
          });
      }.position({x:35,y:630})


    }
    .width("105%")
    .height("100%")
    .backgroundImage($r('app.media.bg1'))
    .backgroundImageSize({ width: "100%", height: "100%" })
    .padding({ top: 20 })


    .onTouch((e) => {
      if (e.type === TouchType.Down && e.touches.length > 0) {
        // è§¦æ‘¸å¼€å§‹ï¼Œè®°å½•åˆå§‹ä½ç½®
        this.screenStartX = e.touches[0].x;
        this.screenStartY = e.touches[0].y;
      } else if (e.type === TouchType.Up && e.changedTouches.length > 0) {
        // å½“æ‰‹æŒ‡æŠ¬èµ·æ—¶ï¼Œæ›´æ–°æœ€åçš„ä½ç½®
        this.lastScreenX = e.changedTouches[0].x;
        this.lastScreenY = e.changedTouches[0].y;
      }
    })
    .gesture(
      SwipeGesture({ direction: SwipeDirection.All }) // æ”¯æŒæ–¹å‘ä¸­ allå¯ä»¥æ˜¯ä¸Šä¸‹å·¦å³
        .onAction((_event: GestureEvent) => {
          const swipeX = this.lastScreenX - this.screenStartX;
          const swipeY = this.lastScreenY - this.screenStartY;
          // æ¸…é™¤å¼€å§‹ä½ç½®è®°å½•ï¼Œå‡†å¤‡ä¸‹ä¸€æ¬¡æ»‘åŠ¨åˆ¤æ–­
          this.screenStartX = 0;
          this.screenStartY = 0;
          if (Math.abs(swipeX) > Math.abs(swipeY)) {
            if (swipeX > 0) {
              // å‘å³æ»‘åŠ¨
              this.movePlayer("right");
            } else {
              // å‘å·¦æ»‘åŠ¨
              this.movePlayer("left");
            }
          } else {
            if (swipeY > 0) {
              // å‘ä¸‹æ»‘åŠ¨
              this.movePlayer("down");
            } else {
              // å‘ä¸Šæ»‘åŠ¨
              this.movePlayer("up");
            }
          }
        })
    );
  }

}